---
## Front matter
title: "Кибербезопасность предприятия"
subtitle: "Лабораторная работа №5. Сценарий 6: Захват сервера базы данных"
author: "Оширова Юлия Николаевна"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: false # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Выполнение лабораторной работы

![Результат сканирования nmap для IP 195.239.174.25](image/1.bmp){#fig:001 width=70%}

На первом этапе выполнения лабораторной работы был проведён разведывательный анализ целевой сети. Для этого использовался инструмент nmap с флагами -sV (определение версии служб) и -sC (запуск стандартных скриптов). В результате сканирования было установлено, что на хосте 195.239.174.25 открыт порт 80/tcp, на котором работает веб-сервер Apache/2.4.29 (Ubuntu). Это указывает на наличие веб-портала, который может быть целью для дальнейшей атаки.

Для удобства работы с сайтом была добавлена статическая запись в файл /etc/hosts, связывающая IP-адрес 195.239.174.25 с доменным именем portal.ampire.corp.

![Получение meterpreter-сессии и сканирование внутренней сети](image/2.bmp){#fig:002 width=70%}

Для обнаружения активных хостов во внутренней сети был запущен модуль post/multi/gather/ping_sweep, который выполнил ping-сканирование диапазона 10.10.10.0/24. В результате было обнаружено несколько активных хостов, включая 10.10.10.5, 10.10.10.10, 10.10.10.15, 10.10.10.20, 10.10.10.25, 10.10.10.30 и 10.10.10.35.

![Поиск модуля сканирования WordPress в Metasploit](image/3.bmp){#fig:003 width=70%}

Для проведения детального анализа целевого сайта, работающего на CMS WordPress, в рамках фреймворка Metasploit был выполнен поиск подходящих модулей с помощью команды search wordpress scanner. В результате поиска был выбран модуль auxiliary/scanner/http/wordpress_scanner, который позволяет автоматически определять установленные плагины и темы на сайте.

Этот модуль был использован для сканирования сайта portal.ampire.corp с целью выявления уязвимых компонентов, которые могут быть использованы для последующей эксплуатации.

![Настройка окружения и запуск Metasploit Framework](image/4.bmp){#fig:004 width=70%}

Перед началом атаки необходимо было настроить локальное окружение. Для этого в файл /etc/hosts была добавлена запись, связывающая IP-адрес 195.239.174.25 с доменным именем portal.ampire.corp. Это позволило обращаться к целевому сайту по удобному имени, а не по IP-адресу.

После настройки окружения был запущен фреймворк Metasploit с помощью команды msfconsole. В консоли Metasploit отобразилась информация о версии фреймворка (v6.4.69-dev) и количестве доступных модулей, включая эксплойты, aux-модули, полезные нагрузки и обходы защиты.

![Разведка дополнительных сервисов в сети](image/5.bmp){#fig:005 width=70%}

На данном этапе была проведена дополнительная разведка для обнаружения других сервисов в сети. Было выполнено сканирование нескольких IP-адресов с помощью команды nmap -sV -sC. В результате сканирования были обнаружены следующие сервисы

Обнаружены:

195.239.174.1: почтовый сервер Microsoft Exchange (порт 25) и Outlook (порт 443).
195.239.174.12: SSH (порт 22) и nginx (порт 443).

![meterpreter > getuid](image/6.bmp){#fig:006 width=70%}

После успешного получения доступа к серверу, в сессии Meterpreter была выполнена команда getuid. Она показала, что текущий пользователь — www-data, что означает успешную эксплуатацию уязвимости и получение контроля над веб-сервером.

![Выбор и настройка эксплойта для wpDiscuz](image/7.bmp){#fig:007 width=70%}

В Metasploit был найден эксплойт wp_wpdiscuz_unauthenticated_file_upload, который позволяет загружать файлы без аутентификации. Были заданы параметры: rhost (целевой хост portal.ampire.corp) и blogpath (путь к посту /index.php/2021/07/26/hello-world/). Также указан lhost — IP локальной машины для обратного соединения.

![Успешное получение meterpreter-сессии](image/8.bmp){#fig:008 width=70%}

После запуска эксплойта (run) система сообщила об успешной загрузке полезной нагрузки и открытии сессии Meterpreter. Сессия №1 установлена между локальным IP 195.239.174.11 и целевым сервером 195.239.174.25. Это подтверждает, что уязвимость успешно эксплуатирована.

![Просмотр ARP-кэша для обнаружения внутренней сети](image/9.bmp){#fig:009 width=70%}

Внутри Meterpreter была выполнена команда arp, чтобы посмотреть ARP-таблицу. В ней видны IP-адреса из диапазона 10.10.10.0/24, что указывает на наличие внутренней сети организации. Это ключевой шаг для планирования дальнейшей атаки внутри периметра.

![Сканирование WordPress для выявления плагинов](image/10.bmp){#fig:010 width=70%}

Был запущен модуль wordpress_scanner для детального анализа сайта. Он определил версию WordPress (5.8.2) и список установленных плагинов, включая wpdiscuz 7.0.2, duplicator 1.3.26 и elementor 3.11.0. Эти данные помогают выбрать вектор атаки — в данном случае был выбран wpdiscuz.

![Сканирование сервера БД через SOCKS-прокси](image/11.bmp){#fig:011 width=70%}

После настройки маршрутизации и SOCKS-прокси, был запущен nmap через proxychains, чтобы просканировать хост 10.10.10.30. Цель — найти открытые порты на внутреннем сервере. Сканирование прошло успешно, но в этом выводе нет информации о конкретных открытых портах.

![Настройка SOCKS-прокси в Metasploit](image/12.bmp){#fig:012 width=70%}

В Meterpreter была выполнена команда bg (background), чтобы временно свернуть сессию. Затем был запущен модуль auxiliary/server/socks_proxy для создания локального прокси-сервера на 127.0.0.1:1080. Это позволяет перенаправлять сетевой трафик из Kali во внутреннюю сеть организации.

![Проверка доступности порта MySQL](image/13.bmp){#fig:013 width=70%}

С помощью утилиты nc (netcat) и proxychains была проверена доступность порта 3306 на сервере 10.10.10.30. Вывод OK подтвердил, что порт открыт — это указывает на то, что на этом хосте работает сервер MySQL, который и является целью атаки.

![Просмотр активных сессий в Metasploit](image/14.bmp){#fig:014 width=70%}

Был выполнен запрос sessions, чтобы убедиться, что активная Meterpreter-сессия №1 всё ещё работает. Информация показывает, что сессия от пользователя www-data на хосте portal.ampire.corp установлена и активна — это гарантирует, что можно продолжать работу.

![Проверка наличия скрипта для брутфорса MySQL](image/15.bmp){#fig:015 width=70%}

В терминале была выполнена команда ls, чтобы убедиться, что нужный скрипт mysql_brute.sh находится в директории /usr/tools/mysql_brute/. Его наличие необходимо для последующего запуска атаки перебором пароля на сервере MySQL.

![Загрузка скрипта для брутфорса MySQL на целевой сервер](image/16.bmp){#fig:016 width=70%}

В Meterpreter была выполнена команда upload, чтобы загрузить скрипт mysql_brute.sh с локальной машины Kali в директорию /tmp/ на скомпрометированном сервере. Это необходимо для запуска атаки перебором пароля прямо с целевого хоста.

![Загрузка словаря rockyou.txt на целевой сервер](image/17.bmp){#fig:017 width=70%}

После загрузки скрипта был загружен и файл со словарём rockyou.txt — стандартный список паролей для брутфорса. Оба файла (mysql_brute.sh и rockyou.txt) теперь находятся в /tmp/ на целевом сервере и готовы к использованию.

![Проверка загруженных файлов в директории /tmp](image/18.bmp){#fig:018 width=70%}

С помощью команд cd /tmp и ls была проверена успешность загрузки файлов. В выводе видны оба файла: mysql_brute.sh (размер 990 байт) и rockyou.txt (размер 139921521 байт). Это подтверждает, что все необходимые компоненты для атаки находятся на целевом хосте.

![Проверка загруженных файлов в директории /tmp](image/19.bmp){#fig:019 width=70%}

На экране отображаются результаты работы скрипта mysql_brute.sh. Скрипт последовательно пытается подключиться к MySQL, используя различные пароли из словаря rockyou.txt для пользователя user. Большинство попыток заканчиваются ошибкой "Ошибка подключения", что означает неверный пароль.

![Успешный брутфорс и получение пароля](image/20.bmp){#fig:020 width=70%}

В конце списка попыток появляется сообщение: «Успешное подключение к базе данных! user: wildflower». Это означает, что скрипт нашёл правильный пароль — wildflower. Теперь можно использовать эти учетные данные для подключения к серверу MySQL и получения флага.

![Просмотр списка баз данных на сервере MySQL](image/21.bmp){#fig:021 width=70%}

После успешного подключения к серверу MySQL с помощью учетных данных user:wildflower, была выполнена команда show databases;. В результате отобразился список доступных баз данных, включая целевую базу Flag, которая содержит искомый флаг.

![Переключение на базу данных и просмотр таблиц](image/22.bmp){#fig:022 width=70%}

Была выбрана база данных Flag с помощью команды use Flag;. Затем выполнена команда show tables;, которая показала, что в этой базе находится одна таблица — lmt0j. Именно в этой таблице хранится флаг.

![Подключение к MySQL через proxychains](image/23.bmp){#fig:023 width=70%}

Из локальной Kali-машины было установлено соединение с сервером MySQL (10.10.10.30) с использованием proxychains для маршрутизации трафика через ранее созданную meterpreter-сессию. Учетные данные: user:wildflower.

![Подтверждение выполнения задания](image/24.bmp){#fig:024 width=70%}

На странице тренировки отображается, что задание «Захват сервера базы данных» успешно выполнено. Это подтверждает, что все шаги атаки были пройдены корректно, и флаг был получен.

![Финальное подтверждение получения флага](image/25.bmp){#fig:025 width=70%}

В окне задания видна зелёная кнопка «Флаг успешно введен», что означает: флаг был найден в таблице lmt0j базы Flag, скопирован и отправлен в систему проверки. Задание полностью завершено.

# Выводы

В ходе выполнения лабораторной работы был успешно реализован сценарий захвата сервера базы данных в корпоративной сети. Атака началась с разведки целевого веб-сервера (portal.ampire.corp), на котором была обнаружена уязвимость в плагине WordPress wpDiscuz. С использованием эксплойта wp_wpdiscuz_unauthenticated_file_upload была получена meterpreter-сессия, что позволило проникнуть во внутреннюю сеть (10.10.10.0/24).

Далее, с помощью маршрутизации (autoroute) и SOCKS-прокси, был проведён скан внутренней сети, в результате которого был обнаружен сервер БД с открытым портом 3306 (MySQL). Используя скрипт mysql_brute.sh и словарь rockyou.txt, был подобран пароль для учётной записи user — wildflower.

После успешного подключения к MySQL был найден флаг в таблице lmt0j базы данных Flag, что подтвердило полное выполнение задачи.